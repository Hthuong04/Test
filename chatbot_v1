# intent_analyzer.py
import json
import re
from openai import OpenAI
from app.core.config import settings

client = OpenAI(api_key=settings.OPENAI_API_KEY)

def extract_json(text: str) -> dict | None:
    """
    Tr√≠ch JSON object ƒë·∫ßu ti√™n trong text
    """
    match = re.search(r"\{.*\}", text, re.S)
    if not match:
        return None
    try:
        return json.loads(match.group())
    except json.JSONDecodeError:
        return None


def analyze_message(message: str) -> dict:
    prompt = f"""
B·∫°n l√† h·ªá th·ªëng ph√¢n t√≠ch c√¢u h·ªèi cho website b√°n m·ªπ ph·∫©m.

H√£y tr·∫£ v·ªÅ DUY NH·∫§T 1 JSON, KH√îNG gi·∫£i th√≠ch, KH√îNG markdown.

Schema:
{{
  "intent": "budget | category | product | general",
  "budget": number ho·∫∑c null,
  "category": string ho·∫∑c null,
  "keywords": [string]
}}

C√¢u h·ªèi:
"{message}"
"""

    res = client.responses.create(
        model="gpt-4.1-mini",
        input=prompt
    )

    text = res.output_text or ""

    data = extract_json(text)

    # üîê FALLBACK AN TO√ÄN
    if not data:
        return {
            "intent": "general",
            "budget": None,
            "category": None,
            "keywords": []
        }

    return data
////

  #response_generator.py
  
from openai import OpenAI
from app.core.config import settings

client = OpenAI(api_key=settings.OPENAI_API_KEY)

def generate_response(message: str, products: list) -> str:
    if not products:
        prompt = f"""
B·∫°n l√† chatbot t∆∞ v·∫•n m·ªπ ph·∫©m.

Kh√°ch h·ªèi:
"{message}"

Y√™u c·∫ßu:
- Kh√¥ng n√≥i shop kh√¥ng c√≥ s·∫£n ph·∫©m
- H·ªèi l·∫°i nhu c·∫ßu c·ª• th·ªÉ
- G·ª£i √Ω nh·∫π nh√†ng
"""
        res = client.responses.create(
            model="gpt-4.1-mini",
            input=prompt
        )
        return res.output_text

    product_context = "\n".join([
        f"- {p.name} | Gi√°: {int(p.price):,}ƒë | Th∆∞∆°ng hi·ªáu: {p.brand or 'Kh√¥ng r√µ'}"
        for p in products
    ])

    prompt = f"""
B·∫°n l√† chatbot t∆∞ v·∫•n cho website b√°n m·ªπ ph·∫©m.

Kh√°ch h·ªèi:
"{message}"

Danh s√°ch s·∫£n ph·∫©m ph√π h·ª£p:
{product_context}

Y√™u c·∫ßu:
- Li·ªát k√™ nhi·ªÅu s·∫£n ph·∫©m
- ∆Øu ti√™n s·∫£n ph·∫©m ph√π h·ª£p nh·∫•t
- Kh√¥ng b·ªãa th√¥ng tin
- Gi·ªØ gi·ªçng t∆∞ v·∫•n th√¢n thi·ªán
"""

    res = client.responses.create(
        model="gpt-4.1-mini",
        input=prompt
    )
    return res.output_text
